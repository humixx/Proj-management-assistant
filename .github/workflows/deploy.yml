name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ==========================================
  # Run CI First
  # ==========================================
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # ==========================================
  # Deploy to EC2
  # ==========================================
  deploy:
    name: Deploy to EC2
    needs: ci
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USERNAME }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
            set -e
            
            echo "ðŸ“ Navigating to project directory..."
            cd /var/www/Proj-management-assistant
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ Updating backend..."
            cd backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            
            echo "ðŸ—„ï¸ Running migrations..."
            alembic upgrade head || echo "No new migrations"
            
            echo "âš›ï¸ Updating frontend..."
            cd ../frontend
            npm ci --silent
            npm run build
            
            echo "ðŸ”„ Restarting services..."
            sudo systemctl restart Proj-management-assistant-api
            sudo systemctl restart Proj-management-assistant-web
            
            echo "âœ… Deployment complete!"
            
            # Health check
            sleep 5
            curl -s http://localhost:8000/health || echo "Backend health check pending..."
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -s http://${{ secrets.EC2_HOST }}:8000/health | grep -q "healthy" && echo "âœ… Backend is healthy!" || echo "âš ï¸ Backend health check failed"